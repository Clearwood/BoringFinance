<template id="render_template">
    <tr>
        <td>{{ asset.symbol }}</td>
        <td class="text-right">
            <span v-if="typeof(asset.decimals) == 'bigint'">
                {{ asset.balance.print(asset.decimals, 2) }}
            </span>
        </td>
        <td class="text-right">
            <span v-if="asset.rate && app.ethRate && !asset.hide_value">
                ${{ (asset.balance * app.ethRate / asset.rate).print(6, 2) }}
            </span>
        </td>
        <td class="text-right">
            <div class="btn-group" role="group" aria-label="Action">
                <button type="button" class="btn btn-sm btn-primary ml-3">Swap</button>
                <button class="btn btn-primary dropdown dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#">Send</a>
                    </div>
                </button>
            </div>
        </td>
    </tr>
</template>
<script>
    addComponent('erc20-view', {
        props: ['asset', 'app'],
        data: function () {
            return {
            }
        }
    })

    class ERC20Handler {
        constructor(assets) {
            this.assets = assets;
            this.componentName = "erc20-view";
        }

        async init() { };

        async find(address, allAssets) {
            let balances = await this.assets.web3.dashboard.findBalances(address, allAssets.map(t => t.address)).call();
            for (var i in balances) {
                if (BigInt(balances[i].balance) > 0n) {
                    let asset = {};
                    if (this.assets._allAssetsMap[balances[i].token]) {
                        objAssign(asset, this.assets._allAssetsMap[balances[i].token]);
                    }
                    objAssign(asset, {
                        address: balances[i].token,
                        balance: BigInt(balances[i].balance),
                        view: 'erc20-view',
                        handler: this
                    });
                    this.assets.add(asset);
                }
            }
        }

        async info(assets) {
            assets = assets.filter(a => !a.name || !a.symbol || (typeof (a.decimals) != "bigint"));
            let infos = await this.assets.web3.dashboard.getTokenInfo(assets.map(t => t.address)).call();
            for (var i in infos) {
                objAssign(this.assets.get(infos[i].token), rpcToObj(infos[i]));
            }
        }

        async poll(address, assets) {
            let balances = await this.assets.web3.dashboard.getBalances(
                address, assets.map(t => t.address),
                "0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f",   // Uniswap (for now), should add to tokenlist.
                "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"    // Use WETH as currency for rate
            ).call();
            for (var i in balances) {
                let asset = this.assets.get(balances[i].token);
                objAssign(asset, rpcToObj(balances[i]));
                if (asset.address == "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2") {
                    asset.rate = 1000000000000000000n;
                }
            }
        }
    }
</script>